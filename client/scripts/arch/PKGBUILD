pkgname=tomato-radio-automation
pkgver=0
pkgrel=1
arch=('x86_64')
url="https://github.com/dtcooper/tomato"
license=('MIT')
# Probably need more, but minimum required to get running
depends=('gtk3' 'nss' 'alsa-lib')
makedepends=('nodejs' 'npm' 'git' 'dpkg')
options=('!strip')

pkgver() {
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "${startdir}/../.."
    npm clean-install
}

build() {
    cd "${startdir}/../.."
    npm run build
    npx electron-forge make --arch x64 --platform linux
}

package() {
    bsdtar -Oxf "${startdir}/../../out/make/deb/x64/"*.deb 'data.tar.*' \
        | bsdtar -C "${pkgdir}" -xf -
    cd "${pkgdir}"

    install -dm 755 usr/lib/udev/rules.d
    ln -s ../../tomato/50-elgato.rules usr/lib/udev/rules.d
}
