pkgname=tomato-radio-automation
pkgver=0
pkgrel=1
arch=('x86_64')
url="https://github.com/dtcooper/tomato"
license=('MIT')
# nodejs-lts-gallium = Node v16
makedepends=('nodejs-lts-gallium' 'npm' 'git' 'dpkg')

pkgver() {
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "${startdir}/../.."
    npm clean-install
}

build() {
    cd "${startdir}/../.."
    npm run build
    npx electron-forge make --arch x64 --platform linux
}

package() {
    bsdtar -Oxf "${startdir}/../../out/make/deb/x64/"*.deb 'data.tar.*' \
        | bsdtar -C "${pkgdir}" -xf -
    cd "${pkgdir}"

    install -dm 755 usr/lib/udev/rules.d
    ln -s ../../tomato/50-elgato.rules usr/lib/udev/rules.d
}
