<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="google" content="notranslate">
  <meta http-equiv="Content-Language" content="en">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tomato MIDI Controller Tester</title>
  <link rel="stylesheet" href="https://unpkg.com/simpledotcss/simple.min.css">
  <style>
    [x-cloak] {
      display: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <script>
    const SYSEX_PREFIX = '!T~'
    const STATS_PREFIX = 'stats/'

    document.addEventListener('alpine:init', () => {
      let midi

      Alpine.data('main', () => ({
        connected: false,
        logLines: [],
        log(s) {
          const date = new Date()
          this.logLines.unshift(`${date.toLocaleDateString()} ${date.toLocaleTimeString()} - ${s}`)
        },
        async init() {
          window.midi = midi = await WebMidi.enable({sysex: true})
          midi.addListener("connected", (event) => {
            const port = event.port
            if (port instanceof Input) {
              this.registerInput(port)
            }
          })
          midi.inputs.forEach(input => this.registerInput(input))
          this.connected = true
          this.log("Connected!")
        },
        led(num, description) {
          this.log(`Setting LED to ${num} (${description})`)
          midi.outputs.forEach((output) => {
            output.channels[1].sendControlChange(0x11, num)
          })
        },
        sysex(data) {
          this.log(`Sending sysex: ${data}`)
          midi.outputs.forEach((output) => {
            output.sendSysex(0x7D, new TextEncoder().encode(`${SYSEX_PREFIX}${data}`))
          })
        },
        sysexResetConfirm(data, confirmMessage) {
          if (confirm(`Are you SURE you want to RESET ${confirmMessage}?`)) {
            this.sysex(data)
          }
        },
        registerInput(input) {
          this.log(`Input: ${input.name}`)
          input.channels[1].removeListener() // Remove all existing listeners
          input.removeListener()
          input.channels[1].addListener("controlchange", (event) => {
            if (event.controller.number === 16) {
              const pressed = event.rawValue === 0
              this.log(`Button ${pressed ? "released" : "pressed"}`)
              if (pressed) {
                this.led(0, 'off, button press')
              }
            }
          })
          input.addListener("sysex", (event) => {
            let message = new TextDecoder().decode(event.message.rawDataBytes)
            if (message.startsWith(SYSEX_PREFIX)) {
              message = message.substr(SYSEX_PREFIX.length)
              if (message.startsWith(STATS_PREFIX)) {
                message = message.substr(STATS_PREFIX.length)
                const stats = JSON.parse(atob(message))
                this.log(`Received stats sysex: ${JSON.stringify(stats, null, 2)}`)
              } else {
                this.log(`Received sysex: ${message}`)
              }
            } else {
              this.log(`Received INVALID sysex: ${message}`)
            }
          })
          input.addListener("reset", (event) => {
            this.log("Device sent reset message")
          })
        }
      }))
    })
  </script>
</head>
<body x-data="main">
  <header>
    <h1>Tomato MIDI Controller Tester</h1>
  </header>

  <main x-show="connected" x-cloak>
    <p>
      <button @click="sysex('ping')">Ping</button>
      <button @click="sysex('stats')">Stats</button>
      <button @click="logLines = []">Clear log</button>
    </p>
    <p>
      <strong>Reset:</strong>
      <button @click="sysexResetConfirm('reset', 'the device')">Reset</button>
      <button @click="sysexResetConfirm('!debug!', 'into DEBUG mode')">Reset into DEBUG mode</button>
      <button @click="sysexResetConfirm('!flash!', 'into FLASH mode')">Reset into FLASH mode</button>
    </p>
    <p>
      <strong>LED Control:</strong>
      <button @click="led(0, 'off')">OFF</button>
      <button @click="led(1, 'on')">ON</button>
      <button @click="led(2, 'flash')">Flash</button>
      <button @click="led(3, 'pulsate slow')">Pulse/slow</button>
      <button @click="led(4, 'pulsate medium')">Pulse/medium</button>
      <button @click="led(5, 'pulsate fast')">Pulse/fast</button>
      <br>
      <strong>Simulate Keypress:</strong>
      <button @click="sysex('simulate-keypress/on')">ON</button>
      <button @click="sysex('simulate-keypress/off')">OFF</button>
      <button @click="sysex('simulate-keypress/full')">Full</button>
    </p>
    <pre x-text="logLines.join('\n')"></pre>
  </main>
</body>
</html>
