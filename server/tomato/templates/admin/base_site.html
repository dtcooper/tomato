{% extends 'admin/base_site.html' %}

{# Disable dark mode #}
{% block dark-mode-vars %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <style>
    :root {
      --primary: #0aa0e1;
      --secondary: #03628c;
      --accent: #ffffff;
      --link-fg: #0a49a1;
      --link-selected-fg: #0a49a1;
    }

    .help {
      font-size: 13px !important;
      line-height: 1.2;
    }

    #s3file-progress-container {
      position: fixed;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 9999;
      width: 100%;
      background-color: transparent;
      height: 10px;
      display: block;
    }

    #s3file-progress-bar {
      background-color: var(--primary);
      width: 0%;
      display: block;
      height: inherit;
    }

    #nav-sidebar .module td .bulk-upload-addlink {
      margin-left: 5px;
    }
  </style>
  {{ COLORS|json_script:"json-tomato-colors" }}
  <script>
    const COLORS = JSON.parse(document.getElementById('json-tomato-colors').textContent)

    document.addEventListener('DOMContentLoaded', () => {
      Array.from(document.querySelectorAll('.app-tomato.module .model-asset .addlink')).forEach((addLink) => {
        const cell = addLink.closest('td')
        const link = document.createElement('a')
        link.classList.add('addlink', 'bulk-upload-addlink')
        link.text = 'Bulk upload'
        link.href = "{% filter escapejs %}{% url 'admin:tomato_asset_upload' %}{% endfilter %}"
        cell.append(link)
      })

      let showProgressBar = false
      const progressBar = document.getElementById('s3file-progress-bar')

      let forms = Array.from(document.querySelectorAll('.s3file')).map((input) => {
        return input.closest('form')
      })

      forms = new Set(forms)
      forms.forEach((form) => {
        form.addEventListener('submit', (event) => {
          event.preventDefault()

          let showProgress = false
          Array.from(form.querySelectorAll('.s3file')).map((input) => {
            showProgress = showProgress || input.files.length > 0
          })

          if (showProgress) {
            Array.from(form.querySelectorAll('input[type=submit], button[type=submit]')).forEach((button) => {
              button.disabled = true
            })

            if (!showProgressBar) {
              form.addEventListener('progress', (event) => {
                progressBar.style.width = `${event.detail.progress * 100}%`
              })
              showProgressBar = true
            }
          }
        })
      })
    })

  </script>
{% endblock %}

{% block userlinks %}
  <a href="https://dtcooper.github.io/tomato/">Help Docs</a> /
  {{ block.super }}
{% endblock %}

{% block header %}
  <div id="s3file-progress-container">
    <span id="s3file-progress-bar"></span>
  </div>
  {{ block.super }}
{% endblock %}
